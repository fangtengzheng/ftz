<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.a.mapper.AddressMapper">

    <resultMap id="ShippingResultMap" type="com.example.a.entity.Shipping">
        <id property="shippingId" column="shipping_id"/>
        <result property="userId" column="user_id"/>
        <result property="receiverName" column="receiver_name"/>
        <result property="receiverPhone" column="receiver_phone"/>
        <result property="receiverProvince" column="receiver_province"/>
        <result property="receiverCity" column="receiver_city"/>
        <result property="receiverDistrict" column="receiver_district"/>
        <result property="receiverAddress" column="receiver_address"/>
        <result property="receiverZip" column="receiver_zip"/>
        <result property="isDefault" column="is_default"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <insert id="insertAddress" parameterType="com.example.a.entity.Shipping">
        INSERT INTO shipping(
            user_id, receiver_name, receiver_phone, receiver_province,
            receiver_city, receiver_district, receiver_address, receiver_zip,
            is_default, create_time, update_time
        ) VALUES (
                     #{userId}, #{receiverName}, #{receiverPhone}, #{receiverProvince},
                     #{receiverCity}, #{receiverDistrict}, #{receiverAddress}, #{receiverZip},
                     #{isDefault}, NOW(), NOW()
                 )
    </insert>
    <update id="clearDefaultAddress">
        <!-- 取消该用户的其他默认地址 -->
        UPDATE shipping
        SET is_default = 0, update_time = NOW()
        WHERE user_id = #{userId} AND is_default = 1;
    </update>

    <update id="setDefaultAddress">
        <!-- 设置指定地址为默认地址 -->
        UPDATE shipping
        SET is_default = 1, update_time = NOW()
        WHERE user_id = #{userId} AND shipping_id = #{shippingId};
    </update>

    <select id="selectAddressById" parameterType="map" resultMap="ShippingResultMap">
        SELECT
            shipping_id,
            user_id,
            receiver_name ,
            receiver_phone,
            receiver_province,
            receiver_city,
            receiver_district,
            receiver_address,
            receiver_zip,
            is_default,
            create_time,
            update_time
        FROM shipping
        WHERE user_id = #{userId} AND shipping_id = #{shippingId}
    </select>

    <select id="selectAddressesByUserId" parameterType="Long" resultMap="ShippingResultMap">
        SELECT
            shipping_id,
            user_id,
            receiver_name,
            receiver_phone,
            receiver_province,
            receiver_city ,
            receiver_district,
            receiver_address,
            receiver_zip,
            is_default,
            create_time,
            update_time
        FROM shipping
        WHERE user_id = #{userId} ORDER BY is_default DESC
    </select>

    <update id="updateAddress" parameterType="com.example.a.entity.Shipping">
        UPDATE shipping
        SET
            receiver_name = #{receiverName},
            receiver_phone = #{receiverPhone},
            receiver_province = #{receiverProvince},
            receiver_city = #{receiverCity},
            receiver_district = #{receiverDistrict},
            receiver_address = #{receiverAddress},
            receiver_zip = #{receiverZip},
            update_time = NOW()
        WHERE user_id = #{userId} AND shipping_id = #{shippingId}
    </update>

    <delete id="deleteAddress">
        DELETE FROM shipping
        WHERE user_id = #{userId} AND shipping_id = #{shippingId}
    </delete>

    <select id="selectDefaultAddress" parameterType="Long" resultMap="ShippingResultMap">
        SELECT
            shipping_id,
            user_id,
            receiver_name,
            receiver_phone,
            receiver_province,
            receiver_city,
            receiver_district,
            receiver_address,
            receiver_zip,
            is_default,
            create_time,
            update_time
        FROM shipping
        WHERE user_id = #{userId} AND is_default = 1
    </select>

</mapper>